name: P09 — SBOM & SCA

on:
  push:
    branches: [ main ]
    paths:
      - '**/requirements*.txt'
      - 'Dockerfile'
      - '.github/workflows/**'
      - 'app/**'
  workflow_dispatch:

permissions:
  contents: read
  # Если хочешь, чтобы workflow мог коммитить sbom прямо в репозиторий,
  # сменим permissions на 'contents: write' (см. шаг Commit SBOM).
concurrency:
  group: p09-sbom-sca-${{ github.ref }}
  cancel-in-progress: true

env:
  SYFT_IMAGE: anchore/syft:0.85.1   # фиксируй версию при необходимости
  GRYPE_IMAGE: anchore/grype:0.68.0
  TRIVY_IMAGE: aquasec/trivy:0.45.0
  EVIDENCE_DIR: EVIDENCE/P09
  SBOM_FILE: ${{ env.EVIDENCE_DIR }}/sbom.json
  SCA_FILE: ${{ env.EVIDENCE_DIR }}/sca_report.json
  SUMMARY_FILE: ${{ env.EVIDENCE_DIR }}/sca_summary.md
  COMMIT_SBOM: "false"   # при желании true — workflow попытается закоммитить sbom

jobs:
  build-sbom-and-sca:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure evidence dir
        run: |
          mkdir -p $EVIDENCE_DIR

      - name: Generate SBOM with Syft (Python/Filesystem)
        # используем контейнерную утилиту syft
        run: |
          docker run --rm -v "${{ github.workspace }}:/work" -w /work $SYFT_IMAGE -o json:./$SBOM_FILE dir:.
        # syft формирует sbom.json в EVIDENCE/P09/sbom.json

      - name: Run SCA with Grype (scan SBOM)
        run: |
          docker run --rm -v "${{ github.workspace }}:/work" -w /work $GRYPE_IMAGE sbom:./$SBOM_FILE -o json > $SCA_FILE || true
        # grype вернёт ненулевой код при нахождении уязвимостей — поэтому || true

      - name: Summarize SCA (simple aggregator)
        run: |
          python - <<'PY'
import json,sys
f = "${{ env.SCA_FILE }}"
out = "${{ env.SUMMARY_FILE }}"
try:
    j = json.load(open(f))
except Exception as e:
    open(out,"w").write("Could not parse SCA report: "+str(e))
    sys.exit(0)

# grype/anchore json has matches/vulnerabilities; try to extract top severities
sevs = {}
# Try common shapes:
if isinstance(j, dict):
    # grype produces "matches" entries
    for k in ("matches","vulnerabilities"):
        items = j.get(k, [])
        for it in items:
            # vulnerability object might be nested
            vuln = it.get("vulnerability") if isinstance(it, dict) and "vulnerability" in it else it
            sev = vuln.get("severity") if isinstance(vuln, dict) else None
            if sev:
                sevs[sev] = sevs.get(sev,0)+1

# fallback: try to scan all dicts for 'severity'
def walk(obj):
    if isinstance(obj, dict):
        if "severity" in obj:
            sevs[obj["severity"]] = sevs.get(obj["severity"],0)+1
        for v in obj.values():
            walk(v)
    elif isinstance(obj, list):
        for i in obj:
            walk(i)
walk(j)

lines = []
lines.append("# SCA summary\n")
lines.append("Generated by CI job: ${{ github.run_id }} (commit ${{ github.sha }})\n")
lines.append("## Counts by severity\n")
if sevs:
    for k in sorted(sevs.keys(), key=lambda s: ['CRITICAL','HIGH','MEDIUM','LOW','UNKNOWN'].index(s) if s in ['CRITICAL','HIGH','MEDIUM','LOW','UNKNOWN'] else 99):
        lines.append(f"- {k}: {sevs[k]}")
else:
    lines.append("- (no severity data found)")

# note top N findings (best effort)
lines.append("\n## Notes\n- For details see `sca_report.json` artifact and the full SBOM `sbom.json`.\n")
open(out,"w").write("\\n".join(lines))
PY

      - name: Upload artifacts (SBOM & SCA & summary)
        uses: actions/upload-artifact@v4
        with:
          name: p09-evidence-${{ github.sha }}
          path: |
            ${{ env.SBOM_FILE }}
            ${{ env.SCA_FILE }}
            ${{ env.SUMMARY_FILE }}
          retention-days: 30

      - name: (optional) Commit SBOM into repository
        if: env.COMMIT_SBOM == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # this step will commit EVIDENCE/P09/sbom.json into the repository so it's tracked.
          # It requires 'contents: write' permission for the workflow.
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add $EVIDENCE_DIR/sbom.json $EVIDENCE_DIR/sca_report.json $EVIDENCE_DIR/sca_summary.md || true
          git commit -m "chore(p09): add SBOM & SCA reports (CI run $GITHUB_RUN_ID)" || echo "nothing to commit"
          git push origin HEAD:${{ github.ref }} || echo "push failed - check permissions"
