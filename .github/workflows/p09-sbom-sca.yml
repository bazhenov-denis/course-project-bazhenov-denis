---

name: P09 — SBOM & SCA

"on":
  push:
    branches: [main]
    paths:
      - '**/requirements*.txt'
      - 'Dockerfile'
      - '.github/workflows/**'
      - 'app/**'
  workflow_dispatch:

permissions:
  contents: read
  # Если хочешь, чтобы workflow мог коммитить sbom прямо в репозиторий,
  # сменим permissions на 'contents: write' (см. шаг Commit SBOM).
concurrency:
  group: p09-sbom-sca-${{github.ref}}
  cancel-in-progress: true

env:
  SYFT_IMAGE: anchore/syft:0.85.1
  GRYPE_IMAGE: anchore/grype:0.68.0
  TRIVY_IMAGE: aquasec/trivy:0.45.0
  EVIDENCE_DIR: EVIDENCE/P09
  SBOM_FILE: ${{env.EVIDENCE_DIR}}/sbom.json
  SCA_FILE: ${{env.EVIDENCE_DIR}}/sca_report.json
  SUMMARY_FILE: ${{env.EVIDENCE_DIR}}/sca_summary.md
  COMMIT_SBOM: "false"

jobs:
  build-sbom-and-sca:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure evidence dir
        run: |
          mkdir -p $EVIDENCE_DIR

      - name: Generate SBOM with Syft (Python/Filesystem)
        run: |
          docker run --rm -v "${{github.workspace}}:/work"
          -w /work $SYFT_IMAGE -o json:./$SBOM_FILE dir:.

      - name: Run SCA with Grype (scan SBOM)
        run: |
          docker run --rm -v "${{github.workspace}}:/work"
          -w /work $GRYPE_IMAGE sbom:./$SBOM_FILE -o json > $SCA_FILE || true

      - name: Summarize SCA (simple aggregator)
        run: |
          python - <<'PY'
          import json
          import sys

          f = "${{env.SCA_FILE}}"
          out = "${{env.SUMMARY_FILE}}"

          try:
              with open(f, "r") as fh:
                  j = json.load(fh)
          except Exception as e:
              with open(out, "w") as fh:
                  fh.write("Could not parse SCA report: " + str(e))
              sys.exit(0)

          sevs = {}

          # Try common shapes (grype)
          if isinstance(j, dict):
              for k in ("matches", "vulnerabilities"):
                  items = j.get(k, [])
                  for it in items:
                      vuln = it.get("vulnerability")
          if isinstance(it, dict) and "vulnerability" in it else it
                      if isinstance(vuln, dict):
                          sev = vuln.get("severity")
                          if sev:
                              sevs[sev] = sevs.get(sev, 0) + 1

          # Fallback: deep scan
          def walk(obj):
              if isinstance(obj, dict):
                  if "severity" in obj:
                      sevs[obj["severity"]] = sevs.get(obj["severity"], 0) + 1
                  for v in obj.values():
                      walk(v)
              elif isinstance(obj, list):
                  for i in obj:
                      walk(i)

          walk(j)

          lines = []
          lines.append("# SCA summary")
          lines.append("")
          lines.append(
              "Generated by CI job: ${{github.run_id}} (commit ${{github.sha}})"
          )
          lines.append("")
          lines.append("## Counts by severity")

          if sevs:
              order = ["CRITICAL", "HIGH", "MEDIUM", "LOW", "UNKNOWN"]
              for k in sorted(sevs.keys(), key=lambda s: order.index(s)
          if s in order else 99):
                  lines.append(f"- {k}: {sevs[k]}")
          else:
              lines.append("- (no severity data found)")

          lines.append("")
          lines.append("## Notes")
          lines.append("- For details see `sca_report.json` and `sbom.json`.")

          with open(out, "w") as fh:
              fh.write("\n".join(lines))
          PY


      - name: Upload artifacts (SBOM & SCA & summary)
        uses: actions/upload-artifact@v4
        with:
          name: p09-evidence-${{ github.sha }}
          path: |
            ${{env.SBOM_FILE}}
            ${{env.SCA_FILE}}
            ${{env.SUMMARY_FILE}}
          retention-days: 30

      - name: (optional) Commit SBOM into repository
        if: env.COMMIT_SBOM == 'true'
        env:
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
        run: |
          git config --global user.email \
            "github-actions[bot]@users.noreply.github.com"
          git config --global user.name \
            "github-actions[bot]"
          git add \
            "$EVIDENCE_DIR/sbom.json" \
            "$EVIDENCE_DIR/sca_report.json" \
            "$EVIDENCE_DIR/sca_summary.md" \
            || true
          git commit \
            -m "chore(p09): add SBOM & SCA reports \
          (CI run $GITHUB_RUN_ID)" \
            || echo "nothing to commit"
          git push origin \
            "HEAD:${{ github.ref }}" \
            || echo "push skipped (no permissions)"
